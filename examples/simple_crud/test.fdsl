// ----------- Server (config) -----------
Server SimpleAPI
  host: "localhost"
  port: 8080
  cors: "http://localhost:3000"
end


// ----------- Sources (REST + WS endpoints) -----------
RESTEndpoint SoilMoistureZone1
  url: "http://localhost:8080/api/soil/moisture/z1"
  verb: GET
end

RESTEndpoint SoilMoistureZone2
  url: "http://localhost:8080/api/soil/moisture/z2"
  verb: GET
end

WSEndpoint FieldCamera
  url: "ws://localhost:8080/ws/camera"
  protocol: "json"
end


// ----------- Entities (data) -----------

// Base entity: direct REST source
Entity MoistureZone1
  source: SoilMoistureZone1
  attributes:
    - timestamp: datetime
    - moisture_percent: float
end

Entity MoistureZone2
  source: SoilMoistureZone2
  attributes:
    - timestamp: datetime
    - moisture_percent: float
end

// Derived entity: joins zone1 & zone2
Entity ZoneDelta
  inputs:
    - z1: MoistureZone1
    - z2: MoistureZone2
  attributes:
    - timestamp = z1.timestamp
    - delta     = z1.moisture_percent - z2.moisture_percent -   fwfwwfew
end

// Aggregated data
Entity AverageMoisture
  inputs:
    - z1: MoistureZone1
    - z2: MoistureZone2
  attributes:
    - zone: string
    - avg_moisture = avg([z2.moisture_percent])
end

// Derived: computed status labels
Entity MoistureWithStatus
  inputs:
    - z: MoistureZone1
  attributes:
    - timestamp = z.timestamp
    - moisture  = z.moisture_percent
    - status    = if z.moisture_percent < 20 then "critical"
                  else if z.moisture_percent < 40 then "low"
                  else "ok"
end

// WebSocket data entity
Entity FieldCameraData
  source: FieldCamera
  attributes:
    - frame: string
    - motion: bool
end


// ----------- Components (UI bindings) -----------

Component<LineChart> MoistureChart
  entity: MoistureWithStatus
  props:
    - description: "Soil Moisture Zone 1"
    - xLabel: "Time"
    - yLabel: "Moisture (%)"
    - xValue: data.timestamp
    - yValues: data.moisture
end

Component<LineChart> DeltaChart
  entity: ZoneDelta 
  props:
    - description: "Moisture Delta Z1 vs Z2"
    - xLabel: "Time"
    - yLabel: "Delta (%)"
    - xValue: data.timestamp
    - yValues: data.delta
end

Component<LiveTable> AvgMoistureTable
  entity: AverageMoisture
  props:
    - primaryKey: "zone"
    - columns: data.zone, data.avg_moisture
end

Component<Image> CameraStream
  entity: FieldCameraData
  props:
    - src: data.frame
    - motionDetected: data.motion
end
