// ============================================
// TEST: WebSocket Header Parameters (Duplex/Publish-Subscribe)
// ============================================
Server TestWSHeadersAPI
  host: "localhost"
  port: 8080
  cors: "*"
  loglevel: debug
end

// --- External WebSocket Echo Server ---
// Echo server sends plain text strings, not JSON
Entity EchoMessageWrapper
  attributes:
    - value: string;
end

Source<WS> EchoServer
  channel: "wss://echo.websocket.org"
  subscribe:
    type: string
    entity: EchoMessageWrapper
end

// --- Transformation entity that enriches echo with header info ---
Entity AuthenticatedEcho(EchoMessageWrapper)
  attributes:
    - originalMessage: string = EchoMessageWrapper.value;
    - authenticatedUser: string = TestWSHeaders.Authorization;
    - sessionId: string = get(TestWSHeaders, "X-Session-ID", "anonymous");
    - enrichedMessage: string = "[User: " + TestWSHeaders.Authorization + ", Session: " + get(TestWSHeaders, "X-Session-ID", "anonymous") + "] " + EchoMessageWrapper.value;
end

// --- WebSocket endpoint with header parameters ---
Endpoint<WS> TestWSHeaders
  channel: "/api/ws/echo/authenticated"
  parameters:
    headers:
      - Authorization: string           // Required - user identifier/token
      - X-Session-ID: string?          // Optional - session tracking
  subscribe:
    type: object
    entity: AuthenticatedEcho
end
