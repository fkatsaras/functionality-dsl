// ============================================
// TEST: Header Parameter Handling
// ============================================
// Demonstrates proper header parameter usage:
// 1. Accepting dynamic headers from clients (X-API-Key, X-Session-ID)
// 2. Forwarding headers to external APIs using expressions
// 3. Using bracket notation for dashed header names
// 4. Accessing header values in entity transformations

Server TestHeadersAPI
  host: "localhost"
  port: 8080
  cors: "*"
  loglevel: debug
end

// --- Schema entities (external API responses) ---
Entity UserDataRaw
  attributes:
    - userId: string;
    - name: string;
    - email: string;
    - role: string;
end

Entity SessionInfoRaw
  attributes:
    - sessionId: string;
    - userId: string;
    - expiresAt: string;
    - active: boolean;
end

// --- External API: Session validation service ---
// Accepts X-Session-ID header and validates it
Source<REST> ValidateSession
  url: "http://dummy-auth:9000/api/validate-session"
  method: GET
  parameters:
    headers:
      - X-Session-ID: string = GetUserProfile["X-Session-ID"];
  response:
    type: object
    entity: SessionInfoRaw
end

// --- External API: User profile service ---
// Requires Authorization header with API key
Source<REST> FetchUserData
  url: "http://dummy-users:9000/api/users/{userId}"
  method: GET
  parameters:
    path:
      - userId: string = SessionInfoRaw.userId;
    headers:
      - Authorization: string = "Bearer " + GetUserProfile["X-API-Key"];
  response:
    type: object
    entity: UserDataRaw
end

// --- Transformation entity ---
Entity AuthenticatedUserProfile(SessionInfoRaw, UserDataRaw)
  attributes:
    - sessionId: string = SessionInfoRaw.sessionId;
    - active: boolean = SessionInfoRaw.active;
    - expiresAt: string = SessionInfoRaw.expiresAt;
    - userId: string = UserDataRaw.userId;
    - name: string = UserDataRaw.name;
    - email: string = UserDataRaw.email;
    - role: string = UserDataRaw.role;
    - requestHeaders: object = {
        "apiKey": GetUserProfile["X-API-Key"],
        "sessionId": GetUserProfile["X-Session-ID"]
      };
end

// --- Public endpoint accepting headers ---
Endpoint<REST> GetUserProfile
  path: "/api/user/profile"
  method: GET
  parameters:
    headers:
      - X-API-Key: string
      - X-Session-ID: string
  response:
    type: object
    entity: AuthenticatedUserProfile
  errors:
    - 401: condition: not SessionInfoRaw.active "Session is not active"
    - 403: condition: UserDataRaw.role != "admin" "Admin access required"
end
