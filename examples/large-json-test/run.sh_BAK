#!/bin/bash

# Test script for large JSON response handling

set -e

echo "=========================================="
echo "Large JSON Response Test"
echo "=========================================="
echo ""

BASE_URL="http://localhost:8080"
DUMMY_URL="http://localhost:9000"

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to test endpoint
test_endpoint() {
    local name=$1
    local url=$2
    local expected_size=$3

    echo -e "${BLUE}Testing: $name${NC}"
    echo "URL: $url"

    # Test with time measurement
    start=$(date +%s.%N)
    response=$(curl -s "$url")
    end=$(date +%s.%N)

    # Calculate duration
    duration=$(echo "$end - $start" | bc)

    # Check if response is valid JSON
    if echo "$response" | python -m json.tool > /dev/null 2>&1; then
        size=$(echo "$response" | wc -c)
        echo -e "${GREEN}OK Valid JSON${NC}"
        echo "  Size: $(numfmt --to=iec-i --suffix=B $size) ($size bytes)"
        echo "  Time: ${duration}s"

        # Check response size expectation
        if [ ! -z "$expected_size" ]; then
            if [ $size -ge $expected_size ]; then
                echo -e "${GREEN}OK Size meets expectation (>= $expected_size bytes)${NC}"
            else
                echo -e "${RED}✗ Size below expectation (< $expected_size bytes)${NC}"
            fi
        fi
    else
        echo -e "${RED}✗ Invalid JSON response${NC}"
        echo "Response preview:"
        echo "$response" | head -20
        return 1
    fi
    echo ""
}

# Function to check if service is running
check_service() {
    local name=$1
    local url=$2

    echo -n "Checking $name... "
    if curl -s "$url/health" > /dev/null 2>&1; then
        echo -e "${GREEN}OK Running${NC}"
        return 0
    else
        echo -e "${RED}✗ Not running${NC}"
        return 1
    fi
}

echo "Step 1: Checking services"
echo "=========================================="
echo -n "Checking Generated API... "
if curl -s "$BASE_URL/api/users?count=10" > /dev/null 2>&1; then
    echo -e "${GREEN}OK Running${NC}"
else
    echo -e "${RED}✗ Not running${NC}"
    echo -e "${RED}Error: Generated API not running on $BASE_URL${NC}"
    echo "Start it with: cd generated && docker compose -p thesis up"
    exit 1
fi

echo -n "Checking Dummy Service... "
if curl -s "$DUMMY_URL/health" > /dev/null 2>&1; then
    echo -e "${GREEN}OK Running${NC}"
else
    echo -e "${RED}✗ Not running${NC}"
    echo -e "${RED}Error: Dummy service not running on $DUMMY_URL${NC}"
    echo "Start it with: cd dummy-service && docker compose up"
    exit 1
fi
echo ""

echo "Step 2: Testing small datasets"
echo "=========================================="
test_endpoint "Users (100 records)" "$BASE_URL/api/users?count=100" 10000
test_endpoint "Analytics (7 days)" "$BASE_URL/api/analytics?days=7" 30000
echo ""

echo "Step 3: Testing medium datasets"
echo "=========================================="
test_endpoint "Users (1000 records)" "$BASE_URL/api/users?count=1000" 100000
test_endpoint "Analytics (30 days)" "$BASE_URL/api/analytics?days=30" 150000
echo ""

echo "Step 4: Testing large datasets"
echo "=========================================="
test_endpoint "Users (5000 records)" "$BASE_URL/api/users?count=5000" 500000
test_endpoint "Users (5000 with metadata)" "$BASE_URL/api/users?count=5000&include_metadata=true" 750000
test_endpoint "Analytics (90 days)" "$BASE_URL/api/analytics?days=90" 500000
echo ""

echo "Step 5: Testing maximum datasets"
echo "=========================================="
test_endpoint "Users (10000 records)" "$BASE_URL/api/users?count=10000" 1000000
test_endpoint "Analytics (365 days)" "$BASE_URL/api/analytics?days=365" 2000000
echo ""

echo "Step 6: Testing nested structures"
echo "=========================================="
test_endpoint "Organization (nested departments)" "$BASE_URL/api/organization" 300000
echo ""

echo "Step 7: Testing error handling"
echo "=========================================="
echo -e "${BLUE}Testing: Invalid count (too low)${NC}"
response=$(curl -s "$BASE_URL/api/users?count=0")
if echo "$response" | grep -q "Count must be between"; then
    echo -e "${GREEN}OK Error handling works${NC}"
else
    echo -e "${RED}✗ Error handling failed${NC}"
fi
echo ""

echo -e "${BLUE}Testing: Invalid count (too high)${NC}"
response=$(curl -s "$BASE_URL/api/users?count=20000")
if echo "$response" | grep -q "Count must be between"; then
    echo -e "${GREEN}OK Error handling works${NC}"
else
    echo -e "${RED}✗ Error handling failed${NC}"
fi
echo ""

echo "Step 8: Verifying computed fields"
echo "=========================================="
echo -e "${BLUE}Fetching users and checking computed fields...${NC}"
response=$(curl -s "$BASE_URL/api/users?count=100")

# Check if key computed fields exist
if echo "$response" | python -c "
import sys, json
data = json.load(sys.stdin)
assert 'totalUsers' in data, 'Missing totalUsers'
assert 'activeUsers' in data, 'Missing activeUsers'
assert 'averageAge' in data, 'Missing averageAge'
assert 'averageSalary' in data, 'Missing averageSalary'
assert 'topCountries' in data, 'Missing topCountries'
assert 'countryCounts' in data, 'Missing countryCounts'
assert len(data['users']) > 0, 'No users in response'
print('All computed fields present')
" 2>&1; then
    echo -e "${GREEN}OK All computed fields present${NC}"
else
    echo -e "${RED}✗ Missing computed fields${NC}"
fi
echo ""

echo "=========================================="
echo -e "${GREEN}All tests completed!${NC}"
echo "=========================================="
