Server WikiLive
  host: "localhost"
  port: 8080
  cors: "http://localhost:3000"
end

// --- External WS feed ------------------------------------------
Source<WS> WikiMonEN
  url: "wss://wikimon.hatnote.com/en/"
  protocol: "json"
  entity_out: WikiEdit
end

// --- Raw entity ------------------------------------------------
// Raw snapshot from the WS frame (map exact keys)
Entity WikiEdit
  source: WikiMonEN
  attributes:
    - title:  string = WikiMonEN["page_title"];
    - user:   string = WikiMonEN["user"];
    - delta:  integer    = WikiMonEN["change_size"];
    - is_bot: boolean   = WikiMonEN["is_bot"];
    - is_minor: boolean = WikiMonEN["is_minor"];
    - wiki:   string = WikiMonEN["ns"];
end

// --- Computed entity -------------------------------------------
Entity EditGauge(WikiEdit)
  attributes:
    - edit_size_abs: integer = (
        abs(WikiEdit.delta) if WikiEdit.delta != null else 0
      );
end


// --- Internal endpoints -----------------------------------------
APIEndpoint<WS> EditGaugeStream
  path: "/api/wiki/edits"
  entity_in: EditGauge
end

APIEndpoint<WS> WikiEditsStream
  path: "/api/wiki/edits/feed"
  entity_in: WikiEdit
end

// --- Components -------------------------------------------------
Component<Gauge> LiveEditSize
  endpoint: EditGaugeStream
  value: data.edit_size_abs
  min: 0
  max: 2000
  label: "Wikipedia edit size (abs bytes)"
  unit: "B"
end

Component<LiveView> WikiEditsFeed
  endpoint: WikiEditsStream
  fields: ["user", "title"]
  label: "Who is editing what (live)"
end
