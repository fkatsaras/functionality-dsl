// =============================================================================
// PARAMETERIZED EDGE CASES TEST
// Tests for parameterized REST and WebSocket sources
// =============================================================================

Server ParamTest
  host: "localhost"
  port: 8080
  cors: "*"
  loglevel: debug
end


// --- PARAMETERIZED REST SOURCE (existing functionality) ---
Source<REST> PostAPI
  url: "https://jsonplaceholder.typicode.com/posts/{post_id}"
  params: [post_id]
  operations: [read]
end

Entity Post
  source: PostAPI
  attributes:
    - id: integer @readonly;
    - userId: integer @readonly;
    - title: string @readonly;
    - body: string @readonly;
  access: public
end


// --- PARAMETERIZED WEBSOCKET SOURCE (new functionality) ---
// Example: Binance WebSocket with symbol parameter
// Real URL would be: wss://stream.binance.com:9443/ws/ethusdt@ticker
// With param: wss://stream.binance.com:9443/ws?streams=ethusdt@ticker
Source<WS> BinanceStream
  channel: "wss://stream.binance.com:9443/ws"
  params: [streams]
  operations: [subscribe]
end

// Base entity that receives raw Binance ticker data
Entity BinanceTick
  flow: inbound
  source: BinanceStream
  attributes:
    - s: string;   // Symbol
    - c: string;   // Current price
    - E: integer;  // Event time
  access: public
end

// Composite entity with transformations
Entity CryptoPrice(BinanceTick)
  flow: inbound
  attributes:
    - symbol: string = BinanceTick.s;
    - price: number = toNumber(BinanceTick.c);
    - priceFormatted: string = "$" + toString(round(toNumber(BinanceTick.c), 2));
    - timestamp: integer = BinanceTick.E;
  access: public
end


// --- PUBLISH WITH PARAMS (outbound) ---
// Example: Publishing to a parameterized WebSocket endpoint
Source<WS> CommandsWS
  channel: "wss://example.com/commands"
  params: [room_id, user_id]
  operations: [publish]
end

// Raw command entity - directly binds to parameterized WS source
Entity RawCommand
  flow: outbound
  source: CommandsWS
  attributes:
    - action: string;
    - payload: string;
  access: public
end
