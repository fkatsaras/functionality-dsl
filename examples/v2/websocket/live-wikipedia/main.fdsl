// ============================================================================
// LIVE WIKIPEDIA EDITS - WebSocket Stream Example
// Demonstrates: WebSocket subscribe operations with transformations
// ============================================================================

Server WikiLive
  host: "localhost"
  port: 8080
  cors: "http://localhost:3000"
  loglevel: debug
end

// ============================================================================
// EXTERNAL WEBSOCKET SOURCE
// ============================================================================

Source<WS> WikiMonEN
  channel: "wss://wikimon.hatnote.com/en/"
  operations: [subscribe]
end

// ============================================================================
// BASE ENTITY - Schema from external WebSocket
// Receives messages from external WS, pushes to clients
// ============================================================================

Entity WikiEdit
  type: inbound
  source: WikiMonEN
  attributes:
    - action: string;
    - change_size: integer;
    - flags: object?;
    - page_namespace: integer?;
    - page_title: string;
    - user: string;
    - server_name: string;
  access: public
end

// ============================================================================
// TRANSFORMED ENTITIES - Apply computations before streaming to clients
// Path auto-generated: /ws/editgauge, /ws/wikieditstream
// ============================================================================

// Computed entity for gauge display (absolute value of change size)
Entity EditGauge(WikiEdit)
  type: inbound
  attributes:
    - edit_size_abs: integer = abs(WikiEdit.change_size);
  access: public
end

// Stream raw edits to client with selected fields
Entity WikiEditStream(WikiEdit)
  type: inbound
  attributes:
    - user: string = WikiEdit.user;
    - page_title: string = WikiEdit.page_title;
    - action: string = WikiEdit.action;
    - change_size: integer = WikiEdit.change_size;
  access: public
end

// ============================================================================
// UI COMPONENTS
// ============================================================================

Component<Gauge> LiveEditSize
  entity: EditGauge
  value: "edit_size_abs"
  min: 0
  max: 2000
  label: "Wikipedia edit size (abs bytes)"
  unit: "B"
end

Component<LiveView> WikiEditsFeed
  entity: WikiEditStream
  fields: ["user", "page_title", "action", "change_size"]
  label: "Who is editing what (live)"
end
