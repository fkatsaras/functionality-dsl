# Testing RBAC in Library API

## Overview

The Library API implements Role-Based Access Control (RBAC) with two roles:
- **librarian**: Can create, update, list, and read most resources
- **admin**: Can perform all operations including delete

## Current Status

✅ **RBAC is fully implemented!** The auth system is now generated and functional:

1. ✅ The FDSL validates that only declared roles are used
2. ✅ The FDSL validates that operations reference valid roles
3. ✅ The permissions are documented in the OpenAPI spec
4. ✅ Auth middleware is generated (`app/core/auth.py`)
5. ✅ FastAPI routes enforce permissions with dependency injection
6. ✅ JWT token validation is implemented

**You can now fully test RBAC with the generated API!**

## Permission Matrix

### Author Entity
| Operation | Roles Required | Default |
|-----------|----------------|---------|
| list      | -              | public  |
| read      | -              | public  |
| create    | librarian, admin | -     |
| update    | librarian, admin | -     |
| delete    | admin          | -       |

### Member Entity
| Operation | Roles Required |
|-----------|----------------|
| list      | librarian, admin |
| read      | librarian, admin |
| create    | librarian, admin |
| update    | librarian, admin |
| delete    | admin |

### Book, Category, Loan Entities
Similar permission structure - see [main.fdsl](main.fdsl) for details.

## How to Test

### 1. Install Dependencies

```bash
pip install pyjwt requests
```

### 2. Generate JWT Tokens

Use the provided script to generate tokens with different roles:

```bash
# Generate admin token
python generate_token.py --user admin_user --roles admin

# Generate librarian token
python generate_token.py --user librarian_user --roles librarian

# Generate multi-role token
python generate_token.py --user super_user --roles librarian,admin
```

### 3. Test with curl

```bash
# Get token first
TOKEN=$(python generate_token.py --user admin_user --roles admin | grep "^eyJ" | tr -d '\n')

# Test public endpoint (should work without token)
curl http://localhost:8000/api/authors

# Test protected endpoint (requires librarian or admin)
curl -H "Authorization: Bearer $TOKEN" \
     -X POST \
     -H "Content-Type: application/json" \
     -d '{"name":"Test Author","bio":"Test bio"}' \
     http://localhost:8000/api/authors

# Test admin-only endpoint (delete)
curl -H "Authorization: Bearer $TOKEN" \
     -X DELETE \
     http://localhost:8000/api/authors/some-id
```

### 4. Run Automated Tests

```bash
# Make sure the API is running
cd generated
docker compose up -d

# Run the test suite
cd ..
python test_rbac.py
```

## JWT Token Structure

Tokens generated by the scripts use this structure:

```json
{
  "sub": "user_id_here",
  "roles": ["librarian", "admin"],
  "exp": 1234567890,
  "iat": 1234567890
}
```

### Token Claims:
- `sub`: User ID (standard JWT subject claim)
- `roles`: Array of role strings (custom claim)
- `exp`: Expiration timestamp
- `iat`: Issued at timestamp

## Server Configuration

The server auth block in [main.fdsl](main.fdsl):

```fdsl
Server LibraryAPI
  auth:
    type: jwt
    roles: ["librarian", "admin"]
    secret_env: "JWT_SECRET"
end
```

This configuration:
- Uses JWT authentication
- Declares two valid roles: librarian, admin
- Reads the secret from `JWT_SECRET` environment variable
- Uses default header: "Authorization"
- Uses default scheme: "Bearer"
- Uses default algorithm: "HS256"
- Uses default user_id_claim: "sub"
- Uses default roles_claim: "roles"

## Environment Setup

Make sure to set the JWT_SECRET in your environment:

```bash
# In .env file
JWT_SECRET=your-secret-key-here

# Or export directly
export JWT_SECRET=your-secret-key-here
```

⚠️ **Security Note**: In production, use a strong, randomly generated secret!

```bash
# Generate a secure secret
python -c "import secrets; print(secrets.token_urlsafe(32))"
```

## Generated Auth Module

The generated `app/core/auth.py` provides:

- **`require_roles(roles: List[str])`**: FastAPI dependency for role-based access control
- **`get_current_user()`**: Dependency to get authenticated user from JWT
- **`get_optional_user()`**: Dependency for optional authentication
- **`create_access_token()`**: Helper function to create JWT tokens (for testing)

### Example Generated Route

```python
from app.core.auth import require_roles

@router.post(
    "",
    response_model=Author,
    status_code=201,
    dependencies=[Depends(require_roles(['librarian', 'admin']))]  # ← Auto-generated
)
async def create_author(
    data: AuthorCreate,
    service: AuthorService = Depends()
) -> Author:
    """Create Author"""
    return await service.create_author(data)
```

Routes without explicit permissions default to public access (no `dependencies` added).

## References

- FDSL Specification: [main.fdsl](main.fdsl)
- Token Generator: [generate_token.py](generate_token.py)
- Test Suite: [test_rbac.py](test_rbac.py)
- Generated API: [generated/](generated/)
