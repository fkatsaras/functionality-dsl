// =============================================================================
// Library Management API - Full CRUD REST Example
// =============================================================================
// This example demonstrates a complete library management system with:
// - Books with authors and categories
// - Members (library patrons)
// - Loans (borrowing records)
// - Full CRUD operations with RBAC
// - Relationships and computed fields
//
// Data Source: Local dummy library service
// =============================================================================

// =============================================================================
// ROLES - First-class declarations with permissions
// =============================================================================

Role admin
  on *: [*]
end

Role librarian
  on AuthorsAPI, BooksAPI, CategoriesAPI, MembersAPI, LoansAPI: [read, create, update]
  on BookDetails, LoanDetails, MemberStats, LibraryStatistics: [read]
end

Role *
  on AuthorsAPI, BooksAPI, CategoriesAPI: [read]
  on BookDetails: [read]
end

// =============================================================================
// AUTHENTICATION - Identity verification (separate from authorization)
// =============================================================================

Auth LibraryAuth
  type: jwt
  secret: "test-secret-key-for-library-api-demo-only-change-in-production"
end

// =============================================================================
// SERVER - Configuration (references Auth by name)
// =============================================================================
  
Server LibraryAPI
  host: "localhost"
  port: 8000
  cors: "*"
  loglevel: debug
  auth: LibraryAuth
end

// =============================================================================
// REST SOURCES - Library Database (capabilities only)
// =============================================================================

Source<REST> AuthorsAPI
  base_url: "http://dummy-library:9200/authors"
  operations: [read, create, update, delete]
end

Source<REST> CategoriesAPI
  base_url: "http://dummy-library:9200/categories"
  operations: [read, create, update, delete]
end

Source<REST> BooksAPI
  base_url: "http://dummy-library:9200/books"
  operations: [read, create, update, delete]
end

Source<REST> MembersAPI
  base_url: "http://dummy-library:9200/members"
  operations: [read, create, update, delete]
end

Source<REST> LoansAPI
  base_url: "http://dummy-library:9200/loans"
  operations: [read, create, update, delete]
end

// =============================================================================
// BASE ENTITIES - Core Library Data
// =============================================================================

Entity Author
  attributes:
    - id: string @id;
    - name: string;
    - birthYear: integer?;
    - nationality: string?;
    - biography: string?;
    - createdAt: string @readonly;
  source: AuthorsAPI
  access: true
end

Entity Category
  attributes:
    - id: string @id;
    - name: string;
    - description: string?;
  source: CategoriesAPI
  access: true
end

Entity Book
  attributes:
    - id: string @id;
    - isbn: string;
    - title: string;
    - authorId: string;
    - categoryId: string;
    - publishedYear: integer;
    - pages: integer?;
    - language: string;
    - availableCopies: integer;
    - totalCopies: integer;
    - createdAt: string @readonly;
  source: BooksAPI
  access: true
end

Entity Member
  attributes:
    - id: string @id;
    - name: string;
    - email: string;
    - phone: string?;
    - address: string?;
    - membershipType: string;
    - joinedDate: string @readonly;
    - active: boolean;
  source: MembersAPI
  access: true
end

Entity Loan
  attributes:
    - id: string @id;
    - bookId: string;
    - memberId: string;
    - loanDate: string;
    - dueDate: string;
    - returnDate: string?;
    - status: string;
    - fine: number;
  source: LoansAPI
  access: true
end

// =============================================================================
// DERIVED ENTITIES - Enriched Data with Relationships
// =============================================================================

Entity BookDetails(Book, Author, Category)
  relationships:
    - Author: Book.authorId
    - Category: Book.categoryId
  attributes:
    - id: string = Book.id;
    - isbn: string = Book.isbn;
    - title: string = Book.title;
    - authorName: string = Author.name;
    - authorNationality: string = get(Author, "nationality", "Unknown");
    - categoryName: string = Category.name;
    - publishedYear: integer = Book.publishedYear;
    - pages: integer = get(Book, "pages", 0);
    - language: string = Book.language;
    - availableCopies: integer = Book.availableCopies;
    - totalCopies: integer = Book.totalCopies;
    - isAvailable: boolean = Book.availableCopies > 0;
  access: true
end

Entity LoanDetails(Loan, Book, Member)
  relationships:
    - Book: Loan.bookId
    - Member: Loan.memberId
  attributes:
    - id: string = Loan.id;
    - bookTitle: string = Book.title;
    - bookIsbn: string = Book.isbn;
    - memberName: string = Member.name;
    - memberEmail: string = Member.email;
    - loanDate: string = Loan.loanDate;
    - dueDate: string = Loan.dueDate;
    - returnDate: string = get(Loan, "returnDate", "Not returned");
    - status: string = Loan.status;
    - fine: number = Loan.fine;
    - isOverdue: boolean = Loan.status == "overdue";
  access: true
end

Entity MemberStats(Member, Loan[])
  relationships:
    - Loan: Member.id
  attributes:
    - id: string = Member.id;
    - name: string = Member.name;
    - email: string = Member.email;
    - membershipType: string = Member.membershipType;
    - active: boolean = Member.active;
    - totalLoans: integer = len(Loan);
    - activeLoans: integer = len(filter(Loan, l => l["status"] == "active"));
    - overdueLoans: integer = len(filter(Loan, l => l["status"] == "overdue"));
    - totalFines: number = round(sum(map(Loan, l => l["fine"])), 2);
  access: true
end

Entity LibraryStatistics(Book[], Member[], Loan[])
  attributes:
    - totalBooks: integer = len(Book);
    - totalMembers: integer = len(Member);
    - activeMembers: integer = len(filter(Member, m => m["active"] == true));
    - totalLoans: integer = len(Loan);
    - activeLoans: integer = len(filter(Loan, l => l["status"] == "active"));
    - overdueLoans: integer = len(filter(Loan, l => l["status"] == "overdue"));
    - totalFines: number = round(sum(map(Loan, l => l["fine"])), 2);
  access: true
end

// =============================================================================
// UI COMPONENTS
// =============================================================================

// Books Management
Component<Table> BooksTable
  entity: BookDetails
  colNames: ["title", "authorName", "categoryName", "publishedYear", "availableCopies"]
end

Component<Table> LoansTable
  entity: LoanDetails
  colNames: ["bookTitle", "memberName", "loanDate", "dueDate", "status", "fine"]
end

Component<Table> MembersTable
  entity: Member
  colNames: ["name", "email", "membershipType", "active"]
end

Component<Table> MemberStatsTable
  entity: MemberStats
  colNames: ["name", "totalLoans", "activeLoans", "overdueLoans", "totalFines"]
end

