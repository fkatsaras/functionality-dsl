// =============================================================================
// Finnhub Stock API - Real-time quotes with company info + Live trades
// =============================================================================

// Inbound auth: JWT for user authentication (uses default DB)
Auth<jwt> UserAuth
  secret: "FINNHUB_JWT_SECRET"
end

Role trader uses UserAuth

// Outbound auth: API Key for Finnhub REST API (header-based)
Auth<apikey> FinnhubAuth
  header: "X-Finnhub-Token"
  secret: "FINNHUB_API_KEY"
end

// Outbound auth: API Key for Finnhub WebSocket (query param based)
Auth<apikey> FinnhubWSAuth
  query: "token"
  secret: "FINNHUB_API_KEY"
end

Server FinnhubStockAPI
  host: "localhost"
  port: 8000
  cors: "*"
  loglevel: debug
end

// -----------------------------------------------------------------------------
// REST Sources - External Finnhub API endpoints
// -----------------------------------------------------------------------------

// Stock quote endpoint - returns current price data
Source<REST> QuoteAPI
  url: "https://finnhub.io/api/v1/quote"
  params: [symbol]
  operations: [read]
  auth: FinnhubAuth
end

// Company profile endpoint - returns company fundamentals
Source<REST> ProfileAPI
  url: "https://finnhub.io/api/v1/stock/profile2"
  params: [symbol]
  operations: [read]
  auth: FinnhubAuth
end

// -----------------------------------------------------------------------------
// WebSocket Sources - Real-time trade streams
// -----------------------------------------------------------------------------

// Finnhub real-time trades WebSocket
// Note: Token is passed as query param in URL
Source<WS> FinnhubTradesWS
  channel: "wss://ws.finnhub.io"
  operations: [subscribe]
  auth: FinnhubWSAuth
end

// -----------------------------------------------------------------------------
// Base Entities - Raw API responses
// -----------------------------------------------------------------------------

// Raw quote data from Finnhub
// API returns: c (current), d (change), dp (percent change), h (high), l (low), o (open), pc (prev close), t (timestamp)
Entity RawQuote
  source: QuoteAPI
  attributes:
    - c: number @readonly;       // Current price
    - d: number @readonly;       // Change
    - dp: number @readonly;      // Percent change
    - h: number @readonly;       // High price of the day
    - l: number @readonly;       // Low price of the day
    - o: number @readonly;       // Open price of the day
    - pc: number @readonly;      // Previous close price
    - t: integer @readonly;      // Timestamp
  access: [trader]
end

// Raw company profile from Finnhub
Entity RawProfile
  source: ProfileAPI
  attributes:
    - ticker: string @readonly;
    - name: string @readonly;
    - country: string @readonly;
    - currency: string @readonly;
    - exchange: string @readonly;
    - ipo: string @readonly;
    - marketCapitalization: number @readonly;
    - shareOutstanding: number @readonly;
    - logo: string @readonly;
    - phone: string @readonly;
    - weburl: string @readonly;
    - finnhubIndustry: string @readonly;
  access: [trader]
end

// -----------------------------------------------------------------------------
// Composite Entity - Transformed stock dashboard
// -----------------------------------------------------------------------------

// Combined stock info with calculated fields
Entity StockDashboard(RawQuote, RawProfile)
  attributes:
    // Company info
    - ticker: string = RawProfile.ticker;
    - companyName: string = RawProfile.name;
    - industry: string = RawProfile.finnhubIndustry;
    - exchange: string = RawProfile.exchange;
    - logoUrl: string = RawProfile.logo;

    // Current price data
    - currentPrice: number = RawQuote.c;
    - priceChange: number = RawQuote.d;
    - percentChange: number = round(RawQuote.dp, 2);

    // Price formatted as string with currency
    - priceFormatted: string = "$" + toString(round(RawQuote.c, 2));
    - changeFormatted: string = toString(round(RawQuote.d, 2)) + " (" + toString(round(RawQuote.dp, 2)) + "%)";

    // Day range
    - dayHigh: number = RawQuote.h;
    - dayLow: number = RawQuote.l;
    - dayRange: string = "$" + toString(round(RawQuote.l, 2)) + " - $" + toString(round(RawQuote.h, 2));

    // Market data
    - openPrice: number = RawQuote.o;
    - previousClose: number = RawQuote.pc;
    - marketCap: number = RawProfile.marketCapitalization;
    - marketCapFormatted: string = "$" + toString(round(RawProfile.marketCapitalization / 1000, 2)) + "B";

    // Calculated metrics
    - priceVsOpen: number = round(RawQuote.c - RawQuote.o, 2);
    - dayVolatility: number = round((RawQuote.h - RawQuote.l) / RawQuote.l * 100, 2);
    - isPositive: boolean = RawQuote.d >= 0;
    - trend: string = "up" if RawQuote.d > 0 else ("down" if RawQuote.d < 0 else "flat");
  access: [trader]
end

// -----------------------------------------------------------------------------
// WebSocket Entities - Real-time trade data
// -----------------------------------------------------------------------------

// Raw trade data from Finnhub WebSocket
// Message format: {"data":[{"c":["1","12"],"p":217.22,"s":"AAPL","t":1704067200000,"v":100}],"type":"trade"}
// c = trade conditions, p = price, s = symbol, t = timestamp (ms), v = volume
Entity RawTrade
  type: inbound
  source: FinnhubTradesWS
  attributes:
    - s: string;         // Symbol (e.g., "AAPL")
    - p: number;         // Last trade price
    - v: number;         // Volume
    - t: integer<int64>; // Timestamp in milliseconds
  access: public
end

// Transformed trade data with human-readable fields
Entity LiveTrade(RawTrade)
  type: inbound
  attributes:
    - symbol: string = RawTrade.s;
    - price: number = RawTrade.p;
    - volume: number = RawTrade.v;
    - timestamp: integer<int64> = RawTrade.t;
    - priceFormatted: string = "$" + toString(round(RawTrade.p, 2));
    - volumeFormatted: string = toString(toInt(RawTrade.v)) + " shares";
  access: public
end
