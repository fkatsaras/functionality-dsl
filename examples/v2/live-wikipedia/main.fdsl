// ============================================================================
// LIVE WIKIPEDIA EDITS - WebSocket Stream Example
// Demonstrates: WebSocket subscribe operations with transformations
// ============================================================================

Server WikiLive
  host: "localhost"
  port: 8080
  cors: "http://localhost:3000"
  loglevel: debug
end

// ============================================================================
// EXTERNAL WEBSOCKET SOURCE
// No subscribe/publish blocks - just like REST sources!
// ============================================================================

Source<WS> WikiMonEN
  channel: "wss://wikimon.hatnote.com/en/"
end

// ============================================================================
// BASE ENTITY - Schema from external WebSocket
// Binds to source just like REST entities
// ============================================================================

Entity WikiEdit
  attributes:
    - action: string;
    - change_size: integer;
    - flags: object?;
    - page_namespace: integer?;
    - page_title: string;
    - user: string;
    - server_name: string;
  source: WikiMonEN
end

// ============================================================================
// SUBSCRIBE ENTITIES - Transform and stream to clients
// Paths auto-generated: /ws/editgauge and /ws/wikieditstream
// ============================================================================

// Computed entity for gauge display (absolute value of change size)
Entity EditGauge(WikiEdit)
  attributes:
    - edit_size_abs: integer = abs(WikiEdit.change_size);
  expose:
    operations: [subscribe]
    // Auto-generated path: /ws/editgauge
end

// Stream raw edits to client
Entity WikiEditStream(WikiEdit)
  attributes:
    - user: string = WikiEdit.user;
    - page_title: string = WikiEdit.page_title;
    - action: string = WikiEdit.action;
    - change_size: integer = WikiEdit.change_size;
  expose:
    operations: [subscribe]
    // Auto-generated path: /ws/wikieditstream
end

// ============================================================================
// UI COMPONENTS
// ============================================================================

Component<Gauge> LiveEditSize
  entity: EditGauge
  value: "edit_size_abs"
  min: 0
  max: 2000
  label: "Wikipedia edit size (abs bytes)"
  unit: "B"
end

Component<LiveView> WikiEditsFeed
  entity: WikiEditStream
  fields: ["user", "page_title", "action", "change_size"]
  label: "Who is editing what (live)"
end
