// Order Management API - With Entity Transformations
// Demonstrates: schema entities, transformation entities with expressions, CRUD exposure

Server OrderAPI
  host: "localhost"
  port: 8080
  cors: "*"
  loglevel: debug
end

// ============================================
// Base Schema Entities (from sources - INTERNAL, not exposed)
// ============================================

// Raw order from database (schema-only, binds to source)
Entity RawOrder
  attributes:
    - id: string;
    - userId: string;
    - items: array;
    - status: string;
    - createdAt: string;
  source: OrderDB
end

// User from database (schema-only, binds to source, EXPOSED directly)
Entity User
  attributes:
    - id: string;
    - email: string;
    - name: string;
    - memberSince: string;
  source: UserDB
  expose:
    rest: "/api/users"
    operations: [list, read]
    id_field: "id"
end

// ============================================
// Transformation Entities (with expressions, EXPOSED)
// ============================================

// Order with computed totals (inherits from RawOrder, adds calculations, EXPOSED via API)
Entity OrderWithTotals(RawOrder)
  attributes:
    - id: string = RawOrder.id;
    - userId: string = RawOrder.userId;
    - items: array = RawOrder.items;
    - itemCount: integer = len(RawOrder.items);
    - subtotal: number = sum(map(RawOrder.items, item => item["price"] * item["quantity"]));
    - tax: number = round(sum(map(RawOrder.items, item => item["price"] * item["quantity"])) * 0.1, 2);
    - total: number = round(sum(map(RawOrder.items, item => item["price"] * item["quantity"])) * 1.1, 2);
    - status: string = RawOrder.status;
    - createdAt: string = RawOrder.createdAt;
  expose:
    rest: "/api/orders"
    operations: [list, read, create, update, delete]
    id_field: "id"
    readonly_fields: ["id", "createdAt", "itemCount", "subtotal", "tax", "total"]
end

// ============================================
// CRUD Sources
// ============================================

Source<REST> OrderDB
  base_url: "http://dummy-order-service:9001/orders"
  crud: standard
    entity: RawOrder
end

Source<REST> UserDB
  base_url: "http://dummy-user-service:9002/users"
  crud: standard
    entity: User
end
