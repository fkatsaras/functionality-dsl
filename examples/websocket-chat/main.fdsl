Server EventServer
  host: "localhost"
  port: 8080
  loglevel: debug
end

// External echo WebSocket service
// We SEND OutgoingProcessed TO external (publish)
// We RECEIVE EchoWrapper FROM external (subscribe)
Source<WS> EchoWS
  channel: "ws://host.docker.internal:8765"
  subscribe:
    type: object
    entity: EchoWrapper
  publish:
    type: object
    entity: OutgoingProcessed
  // auth:
  //   type: bearer
  //   token: "secret123"
end

// OUTBOUND CHAIN (what we send)
// Wrapper for primitive string from client
Entity OutgoingWrapper
  attributes:
    - value: string(3..);
end

Entity OutgoingProcessed(OutgoingWrapper)
  attributes:
    - text: string = upper(OutgoingWrapper.value);
end

// INBOUND CHAIN (what we receive)
// Echo service returns the object we sent, which has "text" field
Entity EchoWrapper
  attributes:
    - text: string;
end

Entity EchoProcessed(EchoWrapper)
  attributes:
    - text: string = lower(EchoWrapper.text);
end

// Internal duplex - handles INBOUND display
Endpoint<WS> ChatDup
  channel: "/api/chat"
  publish:
    type: string
    entity: OutgoingWrapper
  subscribe:
    type: object
    entity: EchoProcessed
  events:
    - 1008:
      condition: len(OutgoingWrapper.value) > 100
      message: "Message too long - maximum 100 characters"
    - 3000:
      condition: OutgoingWrapper.value == "QUIT"
      message: "User requested to quit"
      close: true
end

// ------------------ UI ------------------
Component<Input> ChatBox
  endpoint: ChatDup
  placeholder: "Type your message..."
  label: "Chat"
  submitLabel: "Send"
end

Component<LiveView> ChatFeed
  endpoint: ChatDup
  fields: ["text"]
  label: "Messages"
end
