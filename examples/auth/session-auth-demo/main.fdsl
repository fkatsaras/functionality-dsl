// =============================================================================
// Cookie-based Auth Demo - Using DummyJSON
// =============================================================================
// Demonstrates cookie-based authentication with RBAC using API keys in cookies.
//
// Session keys are configured via environment variable:
//   SESSION_KEYS=admin_session:admin,user_session:user
//
// Test with:
//   curl http://localhost:8080/api/userprofile -b "demo_session=admin_session"
//
// Uses DummyJSON.com as the backing API for testing
// =============================================================================

// Auth mechanism (cookie-based API key for session-like behavior)
Auth<apikey> SessionAuth
  in: cookie
  name: "demo_session"
end

// Roles belong to the auth mechanism
Role user uses SessionAuth
Role admin uses SessionAuth

// Server config (no auth reference needed)
Server SessionDemo
  host: "localhost"
  port: 8080
  cors: "*"
  loglevel: debug
end

// =============================================================================
// REST SOURCES - DummyJSON API
// =============================================================================

Source<REST> UsersAPI
  url: "https://dummyjson.com/users/1"
  operations: [read]
end

Source<REST> ProductsAPI
  url: "https://dummyjson.com/products"
  operations: [read]
end

Source<REST> SingleProductAPI
  url: "https://dummyjson.com/products/1"
  operations: [read]
end

// =============================================================================
// ENTITIES
// =============================================================================

// User profile - accessible by any authenticated user
Entity UserProfile
  source: UsersAPI
  attributes:
    - id: integer @readonly;
    - firstName: string @readonly;
    - lastName: string @readonly;
    - email: string @readonly;
    - phone: string @readonly;
    - username: string @readonly;
    - image: string @readonly;
    - role: string @readonly;
  access: [user, admin]
end

// Product listing - only accessible by admin role
Entity ProductList
  source: ProductsAPI
  attributes:
    - products: array @readonly;
    - total: integer @readonly;
    - skip: integer @readonly;
    - limit: integer @readonly;
  access: [admin]
end

// Single product - accessible by users
Entity Product
  source: SingleProductAPI
  attributes:
    - id: integer @readonly;
    - title: string @readonly;
    - description: string @readonly;
    - price: number @readonly;
    - brand: string @readonly;
    - category: string @readonly;
    - thumbnail: string @readonly;
  access: [user, admin]
end

// Public endpoint - no auth required (derived from UserProfile)
Entity PublicUserInfo(UserProfile)
  attributes:
    - display_name: string = UserProfile.firstName + " " + UserProfile.lastName;
    - username: string = UserProfile.username;
    - has_image: boolean = UserProfile.image != "";
  access: public
end

// Derived product info - public
Entity ProductSummary(Product)
  attributes:
    - name: string = Product.title;
    - price_usd: string = "$" + toString(Product.price);
    - category: string = Product.category;
  access: public
end

// =============================================================================
// UI COMPONENTS - Using EntityCard for single-entity snapshots
// =============================================================================

// Public info card - no auth required
Component<EntityCard> PublicInfoCard
  entity: PublicUserInfo
  type: rest
  fields: ["display_name", "username", "has_image"]
  title: "Public User Info"
end

// Product summary card - public
Component<EntityCard> ProductCard
  entity: ProductSummary
  type: rest
  fields: ["name", "price_usd", "category"]
  title: "Product Summary"
end

// User profile card - requires user/admin role
Component<EntityCard> UserProfileCard
  entity: UserProfile
  type: rest
  fields: ["firstName", "lastName", "email", "username", "role"]
  title: "User Profile"
end

// Product details card - requires user/admin role
Component<EntityCard> ProductDetailsCard
  entity: Product
  type: rest
  fields: ["title", "price", "brand", "category", "description"]
  title: "Product Details"
end

// Admin-only card - shows product list stats
Component<EntityCard> AdminStatsCard
  entity: ProductList
  type: rest
  fields: ["total", "skip", "limit"]
  title: "Admin Stats (Admin Only)"
end

// =============================================================================
// WEBSOCKET SOURCES - Binance Crypto Streams
// =============================================================================

Source<WS> BinanceETH
  channel: "wss://stream.binance.com:9443/ws/ethusdt@ticker"
  operations: [subscribe]
end

Source<WS> BinanceBTC
  channel: "wss://stream.binance.com:9443/ws/btcusdt@ticker"
  operations: [subscribe]
end

// =============================================================================
// WEBSOCKET ENTITIES - With RBAC
// =============================================================================

// Raw ETH tick from Binance
Entity ETHTick
  flow: inbound
  source: BinanceETH
  attributes:
    - s: string;
    - c: string;
    - E: integer;
end

// Raw BTC tick from Binance
Entity BTCTick
  flow: inbound
  source: BinanceBTC
  attributes:
    - s: string;
    - c: string;
    - E: integer;
end

// Public crypto prices - anyone can subscribe
Entity PublicPrices(ETHTick)
  flow: inbound
  attributes:
    - symbol: string = ETHTick.s;
    - price: number = toNumber(ETHTick.c);
    - timestamp: integer = ETHTick.E;
  access: public
end

// User-level prices with more detail - requires user role
Entity UserPrices(ETHTick, BTCTick)
  flow: inbound
  attributes:
    - eth_price: number = toNumber(ETHTick.c);
    - btc_price: number = toNumber(BTCTick.c);
    - spread: number = round(toNumber(BTCTick.c) - toNumber(ETHTick.c), 2);
    - timestamp: integer = ETHTick.E;
  access: [user, admin]
end

// Admin-only analytics - requires admin role
Entity AdminPrices(ETHTick, BTCTick)
  flow: inbound
  attributes:
    - eth_raw: string = ETHTick.c;
    - btc_raw: string = BTCTick.c;
    - eth_price: number = toNumber(ETHTick.c);
    - btc_price: number = toNumber(BTCTick.c);
    - ratio: number = round(toNumber(BTCTick.c) / toNumber(ETHTick.c), 4);
    - timestamp: integer = ETHTick.E;
  access: [admin]
end

// =============================================================================
// WEBSOCKET UI COMPONENTS
// =============================================================================

// Public live chart - no auth required
Component<LiveChart> PublicCryptoChart
  entity: PublicPrices
  seriesLabels: ["price"]
  xLabel: "Time"
  yLabel: "Price (USD)"
  windowSize: 50
end

// User live chart - requires user role
Component<LiveChart> UserCryptoChart
  entity: UserPrices
  seriesLabels: ["eth_price", "btc_price"]
  xLabel: "Time"
  yLabel: "Price (USD)"
  windowSize: 50
end

// Admin live chart - requires admin role
Component<LiveChart> AdminCryptoChart
  entity: AdminPrices
  seriesLabels: ["eth_price", "btc_price", "ratio"]
  xLabel: "Time"
  yLabel: "Price (USD)"
  windowSize: 50
end
