// Large JSON Response Test
// Tests FDSL handling of substantial JSON payloads with nested structures

Server LargeDataAPI
  host: "localhost"
  port: 8080
  cors: "*"
  loglevel: debug
end

// ============================================================================
// EXTERNAL SOURCES (Act like database queries - return large datasets)
// ============================================================================

// Source that returns a large array of user records (all users from DB)
Source<REST> UsersDataSource
  url: "http://dummy-large-data:9000/api/users"
  method: GET
  response:
    type: array
    entity: UserRecordsWrapper
end

// Source that returns analytics data with nested structures (all analytics from DB)
Source<REST> AnalyticsDataSource
  url: "http://dummy-large-data:9000/api/analytics"
  method: GET
  response:
    type: object
    entity: AnalyticsData
end

// Source that returns deeply nested organizational data (full org tree from DB)
Source<REST> OrgDataSource
  url: "http://dummy-large-data:9000/api/organization"
  method: GET
  response:
    type: object
    entity: OrganizationData
end


Entity UserRecord
  attributes:
    - id: string;
    - username: string;
    - email: string;
    - firstName: string;
    - lastName: string;
    - age: integer;
    - country: string;
    - city: string;
    - occupation: string;
    - salary: number;
    - joinDate: string;
    - isActive: boolean;
    - tags: array;
    - metadata: object?;
end

Entity UserRecordsWrapper
  attributes:
    - items: array<UserRecord>;
end

Entity DailyMetrics
  attributes:
    - date: string;
    - pageViews: integer;
    - uniqueVisitors: integer;
    - bounceRate: number;
    - avgSessionDuration: number;
    - topPages: array;
    - deviceBreakdown: object;
end

Entity AnalyticsData
  attributes:
    - period: string;
    - totalUsers: integer;
    - totalRevenue: number;
    - dailyMetrics: array<DailyMetrics>;
    - topProducts: array;
    - conversionRates: object;
end

Entity Employee
  attributes:
    - id: string;
    - name: string;
    - role: string;
    - department: string;
    - salary: number;
    - projects: array;
end

Entity Department
  attributes:
    - id: string;
    - name: string;
    - budget: number;
    - employees: array<Employee>;
    - subDepartments: array<Department>?;
end

Entity OrganizationData
  attributes:
    - companyName: string;
    - totalEmployees: integer;
    - departments: array<Department>;
    - locations: array;
end

// ============================================================================
// TRANSFORMATION ENTITIES (With computed attributes)
// ============================================================================

Entity UserSummary(UserRecordsWrapper)
  attributes:
    - totalUsers: integer = len(UserRecordsWrapper.items);
    - activeUsers: integer = len(filter(UserRecordsWrapper.items, u => u["isActive"]));
    - averageAge: number = round(avg(map(UserRecordsWrapper.items, u => u["age"])), 2) if len(UserRecordsWrapper.items) > 0 else 0;
    - averageSalary: number = round(avg(map(UserRecordsWrapper.items, u => u["salary"])), 2) if len(UserRecordsWrapper.items) > 0 else 0;
    - limitedItems: array = UserRecordsWrapper.items[:GetUsers.limit] if GetUsers.limit else UserRecordsWrapper.items;
    - users: array = map(
        UserSummary.limitedItems,
        u => {
          "id": u["id"],
          "name": u["firstName"] + " " + u["lastName"],
          "email": u["email"],
          "location": u["city"] + ", " + u["country"],
          "occupation": u["occupation"],
          "salary": u["salary"],
          "age": u["age"],
          "isActive": u["isActive"],
          "metadata": u["metadata"] if GetUsers.include_metadata else null
        }
      );
    - countries: array = map(UserRecordsWrapper.items, u => u["country"]);
end

Entity AnalyticsSummary(AnalyticsData)
  attributes:
    - period: string = AnalyticsData.period;
    - filteredMetrics: array = AnalyticsData.dailyMetrics[:GetAnalytics.days] if GetAnalytics.days else AnalyticsData.dailyMetrics;
    - overview: object = {
        "totalUsers": AnalyticsData.totalUsers,
        "totalRevenue": AnalyticsData.totalRevenue,
        "daysAnalyzed": len(AnalyticsSummary.filteredMetrics)
      };
    - averageMetrics: object = {
        "avgPageViews": round(avg(map(AnalyticsSummary.filteredMetrics, d => d["pageViews"])), 2) if len(AnalyticsSummary.filteredMetrics) > 0 else 0,
        "avgUniqueVisitors": round(avg(map(AnalyticsSummary.filteredMetrics, d => d["uniqueVisitors"])), 2) if len(AnalyticsSummary.filteredMetrics) > 0 else 0,
        "avgBounceRate": round(avg(map(AnalyticsSummary.filteredMetrics, d => d["bounceRate"])), 4) if len(AnalyticsSummary.filteredMetrics) > 0 else 0,
        "avgSessionDuration": round(avg(map(AnalyticsSummary.filteredMetrics, d => d["avgSessionDuration"])), 2) if len(AnalyticsSummary.filteredMetrics) > 0 else 0
      };
    - bestDay: object? = sortBy(AnalyticsSummary.filteredMetrics, d => -d["pageViews"])[0] if len(AnalyticsSummary.filteredMetrics) > 0 else null;
    - worstDay: object? = sortBy(AnalyticsSummary.filteredMetrics, d => d["bounceRate"])[-1] if len(AnalyticsSummary.filteredMetrics) > 0 else null;
    - dailyTrends: array = map(AnalyticsSummary.filteredMetrics, d => {
        "date": d["date"],
        "pageViews": d["pageViews"],
        "uniqueVisitors": d["uniqueVisitors"],
        "bounceRate": d["bounceRate"]
      });
end

Entity OrgSummary(OrganizationData)
  attributes:
    - companyName: string = OrganizationData.companyName;
    - totalEmployees: integer = OrganizationData.totalEmployees;
    - departmentCount: integer = len(OrganizationData.departments);
    - totalBudget: number = sum(map(OrganizationData.departments, d => d["budget"]));
    - averageBudget: number = round(sum(map(OrganizationData.departments, d => d["budget"])) / len(OrganizationData.departments), 2);
    - departments: array = map(OrganizationData.departments, dept => {
        "id": dept["id"],
        "name": dept["name"],
        "budget": dept["budget"],
        "employeeCount": len(dept["employees"]),
        "avgSalary": round(sum(map(dept["employees"], e => e["salary"])) / len(dept["employees"]), 2) if len(dept["employees"]) > 0 else 0,
        "hasSubDepartments": dept["subDepartments"] != null and len(dept["subDepartments"]) > 0
      });
end


// Fetch all users from DB, then limit and filter in FDSL
Endpoint<REST> GetUsers
  path: "/api/users"
  method: GET
  parameters:
    query:
      - limit: integer?;
      - include_metadata: boolean = false;
  response:
    type: object
    entity: UserSummary
end

// Fetch all analytics from DB, then filter by days in FDSL
Endpoint<REST> GetAnalytics
  path: "/api/analytics"
  method: GET
  parameters:
    query:
      - days: integer = 30;
  response:
    type: object
    entity: AnalyticsSummary
  errors:
    - 400:
      condition: GetAnalytics.days < 1 or GetAnalytics.days > 365
      message: "Days must be between 1 and 365"
end

// Returns organizational hierarchy with computed budget summaries
Endpoint<REST> GetOrganization
  path: "/api/organization"
  method: GET
  response:
    type: object
    entity: OrgSummary
end
