{# templates/frontend/+page.svelte.jinja #}
{% import 'component_macros.jinja' as macros with context %}

{% set uniq = namespace(kinds=[]) %}
{% for cmp in components %}
    {% set k = cmp.kind %}
    {% if k not in uniq.kinds %}
        {% set uniq.kinds = uniq.kinds + [k] %}
    {% endif %}
{% endfor %}

<script lang="ts">
    import ThemeToggle from "$lib/components/ThemeToggle.svelte";
    {% if auth %}
    import { authStore } from "$lib/stores/authStore";
    import AuthLogin from "$lib/components/AuthLogin.svelte";
    import Unauthorized from "$lib/components/Unauthorized.svelte";
    {% endif %}
    {% for k in uniq.kinds %}
    import {{ k }} from "$lib/components/{{ k }}.svelte";
    {% endfor %}
    {% if auth %}

    let authState = $state({ isAuthenticated: false, token: null, userId: null, roles: [] as string[] });
    authStore.subscribe((state) => {
        authState = state;
    });

    function canAccessComponent(componentName: string): boolean {
        const perm = componentPermissions[componentName];
        if (!perm) return true;

        const roles = perm.roles;
        if (roles.includes("public")) return true;

        return roles.some(role => authState.roles.includes(role));
    }

    function getComponentPermission(componentName: string) {
        return componentPermissions[componentName];
    }

    const componentPermissions: Record<string, {entity: string, operation: string, roles: string[]}> = {{ component_permissions | tojson }};
    {% endif %}
</script>

{% if auth %}
{% raw %}{#if !authState.isAuthenticated}{% endraw %}
    <AuthLogin authMechanisms={{ '{' }}{{ auth_mechanisms | tojson }}{{ '}' }} />
{% raw %}{:else}{% endraw %}
    <div class="dashboard-container mx-auto max-w-[1800px] px-10 py-12">
        <div class="dashboard-header mb-6">
            <ThemeToggle />
            <div class="auth-info">
                <svg class="user-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                </svg>
                <span class="user-name">{% raw %}{authState.userId}{% endraw %}</span>
                <div class="role-badge">
                    <svg class="shield-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.516 2.17a.75.75 0 0 0-1.032 0 11.209 11.209 0 0 1-7.877 3.08.75.75 0 0 0-.722.515A12.74 12.74 0 0 0 2.25 9.75c0 5.942 4.064 10.933 9.563 12.348a.749.749 0 0 0 .374 0c5.499-1.415 9.563-6.406 9.563-12.348 0-1.39-.223-2.73-.635-3.985a.75.75 0 0 0-.722-.516l-.143.001c-2.996 0-5.717-1.17-7.734-3.08Zm3.094 8.016a.75.75 0 1 0-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 0 0-1.06 1.06l2.25 2.25a.75.75 0 0 0 1.14-.094l3.75-5.25Z" clip-rule="evenodd" />
                    </svg>
                    <span>{% raw %}{authState.roles.join(", ")}{% endraw %}</span>
                </div>
                <button
                    class="logout-button"
                    onclick={% raw %}{() => authStore.logout()}{% endraw %}
                >
                    <svg class="logout-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m3 0 3-3m0 0-3-3m3 3H9" />
                    </svg>
                    Logout
                </button>
            </div>
        </div>
        <div class="dashboard-grid">
            {% for cmp in components %}
                <div class="dashboard-item">
                    <div class="dashboard-card">
                        {% raw %}{#if canAccessComponent("{% endraw %}{{ cmp.name }}{% raw %}")}{% endraw %}
                            {{ macros.render_component(cmp) }}
                        {% raw %}{:else}{% endraw %}
                            {% raw %}{@const perm = getComponentPermission("{% endraw %}{{ cmp.name }}{% raw %}")}{% endraw %}
                            <Unauthorized
                                requiredRoles={% raw %}{perm.roles}{% endraw %}
                                operation={% raw %}{perm.operation}{% endraw %}
                            />
                        {% raw %}{/if}{% endraw %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
{% raw %}{/if}{% endraw %}
{% else %}
<div class="dashboard-container mx-auto max-w-[1800px] px-10 py-12">
    <div class="dashboard-header mb-6">
        <ThemeToggle />
    </div>
    <div class="dashboard-grid">
        {% for cmp in components %}
            <div class="dashboard-item">
                <div class="dashboard-card">
                    {{ macros.render_component(cmp) }}
                </div>
            </div>
        {% endfor %}
    </div>
</div>
{% endif %}
