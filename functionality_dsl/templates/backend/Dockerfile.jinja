FROM python:3.11-slim

WORKDIR /app
RUN apt-get update && apt-get install -y --no-install-recommends \
    iputils-ping curl dnsutils net-tools \
 && rm -rf /var/lib/apt/lists/*

RUN pip install --no-cache-dir --upgrade pip

COPY pyproject.toml ./
RUN python - <<'PY'
import tomllib, subprocess, sys
with open('pyproject.toml','rb') as f:
    d = tomllib.load(f)
    deps = d['project']['dependencies']
    subprocess.check_call([sys.executable, '-m', 'pip', 'install', '--no-cache-dir', *deps])
PY

COPY app ./app

EXPOSE {{ server.port }}

CMD ["uvicorn", "app.main:app", "--host=0.0.0.0", "--port={{ server.port }}"]
