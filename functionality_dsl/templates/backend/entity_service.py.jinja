# ========================================================================
# AUTO-GENERATED ENTITY SERVICE: {{ entity_name }}
# Generated from entity-centric exposure configuration
# ========================================================================

import logging
from typing import Optional, List

from app.domain.models import {{ entity_name }}
from app.sources.{{ source_name | lower }}_source import {{ source_name }}Source
{% if has_computed_attrs %}
from app.core.safe_eval import safe_eval, get_dsl_funcs
{% endif %}


logger = logging.getLogger("fdsl.service.{{ entity_name }}")


class {{ entity_name }}Service:
    """Service layer for {{ entity_name }} CRUD operations"""

    def __init__(self):
        self.source = {{ source_name }}Source()

{% for op in operations %}
    {%- if op.operation == "list" %}
    async def list_{{ entity_name | lower }}(self) -> List[{{ entity_name }}]:
        """List all {{ entity_name }} instances"""
        logger.debug("Listing {{ entity_name }} instances")

        # Fetch from source
        raw_data = await self.source.list()

        {% if has_computed_attrs %}
        # TODO: Transform entities if needed
        # For now, return raw data
        return [{{ entity_name }}(**item) for item in raw_data]
        {% else %}
        return [{{ entity_name }}(**item) for item in raw_data]
        {% endif %}

    {%- elif op.operation == "read" %}
    async def get_{{ entity_name | lower }}(self, {{ id_field }}: str) -> Optional[{{ entity_name }}]:
        """Get a single {{ entity_name }} by ID"""
        logger.debug(f"Getting {{ entity_name }}: {{'{'}}{{ id_field }}{{'}'}}")

        # Fetch from source
        raw_data = await self.source.read({{ id_field }})

        if not raw_data:
            return None

        {% if has_computed_attrs %}
        # TODO: Compute entity attributes if needed
        # For now, return raw data
        return {{ entity_name }}(**raw_data)
        {% else %}
        return {{ entity_name }}(**raw_data)
        {% endif %}

    {%- elif op.operation == "create" %}
    async def create_{{ entity_name | lower }}(self, data) -> {{ entity_name }}:
        """Create a new {{ entity_name }}"""
        logger.debug(f"Creating {{ entity_name }}: {data}")

        # Call source create operation
        created = await self.source.create(data.dict())

        return {{ entity_name }}(**created)

    {%- elif op.operation == "update" %}
    async def update_{{ entity_name | lower }}(self, {{ id_field }}: str, data) -> Optional[{{ entity_name }}]:
        """Update an existing {{ entity_name }}"""
        logger.debug(f"Updating {{ entity_name }}: {{'{'}}{{ id_field }}{{'}'}}")

        # Call source update operation
        updated = await self.source.update({{ id_field }}, data.dict())

        if not updated:
            return None

        return {{ entity_name }}(**updated)

    {%- elif op.operation == "delete" %}
    async def delete_{{ entity_name | lower }}(self, {{ id_field }}: str) -> None:
        """Delete a {{ entity_name }}"""
        logger.debug(f"Deleting {{ entity_name }}: {{'{'}}{{ id_field }}{{'}'}}")

        # Call source delete operation
        await self.source.delete({{ id_field }})

    {%- endif %}

{% endfor %}
