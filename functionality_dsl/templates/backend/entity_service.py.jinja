# ========================================================================
# AUTO-GENERATED ENTITY SERVICE: {{ entity_name }}
# Generated from entity-centric exposure configuration
# ========================================================================

import logging
from typing import Optional, List

from app.domain.models import {{ entity_name }}
from app.sources.{{ source_name | lower }}_source import {{ source_name }}Source
{% if has_computed_attrs %}
from app.core.service_helpers import transform_entity_data
from app.core.runtime.safe_eval import compile_safe, safe_globals
{% endif %}


logger = logging.getLogger("fdsl.service.{{ entity_name }}")


class {{ entity_name }}Service:
    """Service layer for {{ entity_name }} CRUD operations"""

    def __init__(self):
        self.source = {{ source_name }}Source()

{% if has_computed_attrs %}
    def _transform_entity(self, raw_data: dict) -> dict:
        """Transform raw source data to {{ entity_name }} using computed attributes."""
        context = {}

        # Add parent entity data to context
        {% for parent in parents %}
        context["{{ parent }}"] = raw_data
        {% endfor %}

        # Transform entity data
        transformed = transform_entity_data(
            entity_name="{{ entity_name }}",
            attributes=[
                {% for attr in computed_attrs %}
                {"name": "{{ attr.name }}", "expr": """{{ attr.expr }}"""},
                {% endfor %}
            ],
            context=context,
            safe_globals=safe_globals,
            compile_safe_fn=compile_safe,
            logger=logger
        )

        return transformed

{% endif %}
{% for op in operations %}
    {%- if op.operation == "list" %}
    async def list_{{ entity_name | lower }}(self) -> List[{{ entity_name }}]:
        """List all {{ entity_name }} instances"""
        logger.debug("Listing {{ entity_name }} instances")

        # Fetch from source
        raw_data = await self.source.list()

        {% if has_computed_attrs %}
        # Transform each item
        transformed_items = [self._transform_entity(item) for item in raw_data]
        return [{{ entity_name }}(**item) for item in transformed_items]
        {% else %}
        return [{{ entity_name }}(**item) for item in raw_data]
        {% endif %}

    {%- elif op.operation == "read" %}
    {%- if op.is_item_op %}
    async def get_{{ entity_name | lower }}(self, {{ id_field }}: str) -> Optional[{{ entity_name }}]:
        """Get a single {{ entity_name }} by ID"""
        logger.debug(f"Getting {{ entity_name }}: {{'{'}}{{ id_field }}{{'}'}}")

        # Fetch from source
        raw_data = await self.source.read({{ id_field }})

        if not raw_data:
            return None

        {% if has_computed_attrs %}
        # Transform entity
        transformed = self._transform_entity(raw_data)
        return {{ entity_name }}(**transformed)
        {% else %}
        return {{ entity_name }}(**raw_data)
        {% endif %}
    {%- else %}
    async def get_{{ entity_name | lower }}(self) -> {{ entity_name }}:
        """Get the singleton {{ entity_name }} instance"""
        logger.debug("Getting {{ entity_name }} (singleton)")

        # Fetch from source
        raw_data = await self.source.read()

        {% if has_computed_attrs %}
        # Transform entity
        transformed = self._transform_entity(raw_data)
        return {{ entity_name }}(**transformed)
        {% else %}
        return {{ entity_name }}(**raw_data)
        {% endif %}
    {%- endif %}

    {%- elif op.operation == "create" %}
    async def create_{{ entity_name | lower }}(self, data) -> {{ entity_name }}:
        """Create a new {{ entity_name }}"""
        logger.debug(f"Creating {{ entity_name }}: {data}")

        # Call source create operation
        created = await self.source.create(data.dict())

        {% if has_computed_attrs %}
        # Transform created entity
        transformed = self._transform_entity(created)
        return {{ entity_name }}(**transformed)
        {% else %}
        return {{ entity_name }}(**created)
        {% endif %}

    {%- elif op.operation == "update" %}
    async def update_{{ entity_name | lower }}(self, {{ id_field }}: str, data) -> Optional[{{ entity_name }}]:
        """Update an existing {{ entity_name }}"""
        logger.debug(f"Updating {{ entity_name }}: {{'{'}}{{ id_field }}{{'}'}}")

        # Call source update operation
        updated = await self.source.update({{ id_field }}, data.dict())

        if not updated:
            return None

        {% if has_computed_attrs %}
        # Transform updated entity
        transformed = self._transform_entity(updated)
        return {{ entity_name }}(**transformed)
        {% else %}
        return {{ entity_name }}(**updated)
        {% endif %}

    {%- elif op.operation == "delete" %}
    async def delete_{{ entity_name | lower }}(self, {{ id_field }}: str) -> None:
        """Delete a {{ entity_name }}"""
        logger.debug(f"Deleting {{ entity_name }}: {{'{'}}{{ id_field }}{{'}'}}")

        # Call source delete operation
        await self.source.delete({{ id_field }})

    {%- endif %}

{% endfor %}
