"""
Tests for {{ entity.name }} entity.

Generated by FDSL from {{ fdsl_file }}.
"""
import pytest
from fastapi.testclient import TestClient
{% if has_auth %}
from sqlmodel import Session
{% endif %}


{% if 'read' in entity.operations %}
def test_read_{{ entity.name | lower }}(
    client: TestClient,
    {% if entity.access.read != 'public' %}
    {% if entity.access.read_roles %}test_user_headers: dict[str, str]{% else %}test_user_token: str{% endif %}
    {% endif %}
) -> None:
    """Test reading {{ entity.name }}."""
    response = client.get(
        "/api/{{ entity.name | lower }}"
        {% if entity.access.read != 'public' %}
        , headers=test_user_headers
        {% endif %}
    )
    {% if entity.access.read == 'public' or entity.access.read_roles %}
    assert response.status_code == 200
    data = response.json()
    assert data is not None
    {% if entity.attributes %}
    # Check response schema
    {% for attr in entity.attributes %}
    {% if not attr.is_computed or attr.readonly %}
    assert "{{ attr.name }}" in data
    {% endif %}
    {% endfor %}
    {% endif %}
    {% else %}
    # Should fail without proper authentication
    assert response.status_code in [401, 403]
    {% endif %}


{% if entity.access.read_roles and admin_role in entity.access.read_roles %}
def test_read_{{ entity.name | lower }}_unauthorized(client: TestClient) -> None:
    """Test reading {{ entity.name }} without authentication fails."""
    response = client.get("/api/{{ entity.name | lower }}")
    assert response.status_code in [401, 403]
    data = response.json()
    assert "detail" in data
{% endif %}
{% endif %}


{% if 'create' in entity.operations %}
def test_create_{{ entity.name | lower }}(
    client: TestClient,
    {% if entity.access.create != 'public' %}
    {% if entity.access.create_roles %}test_user_headers: dict[str, str]{% else %}test_user_token: str{% endif %}
    {% endif %}
) -> None:
    """Test creating {{ entity.name }}."""
    data = {
        {% for attr in entity.attributes %}
        {% if not attr.readonly and not attr.is_computed %}
        "{{ attr.name }}": {{ attr.test_value }},
        {% endif %}
        {% endfor %}
    }
    response = client.post(
        "/api/{{ entity.name | lower }}",
        json=data
        {% if entity.access.create != 'public' %}
        , headers=test_user_headers
        {% endif %}
    )
    {% if entity.access.create == 'public' or entity.access.create_roles %}
    assert response.status_code == 200
    result = response.json()
    {% for attr in entity.attributes %}
    {% if not attr.readonly and not attr.is_computed %}
    assert result["{{ attr.name }}"] == data["{{ attr.name }}"]
    {% endif %}
    {% endfor %}
    {% else %}
    # Should fail without proper authentication
    assert response.status_code in [401, 403]
    {% endif %}


{% if entity.access.create_roles and admin_role in entity.access.create_roles %}
def test_create_{{ entity.name | lower }}_unauthorized(client: TestClient) -> None:
    """Test creating {{ entity.name }} without authentication fails."""
    data = {
        {% for attr in entity.attributes %}
        {% if not attr.readonly and not attr.is_computed %}
        "{{ attr.name }}": {{ attr.test_value }},
        {% endif %}
        {% endfor %}
    }
    response = client.post("/api/{{ entity.name | lower }}", json=data)
    assert response.status_code in [401, 403]
{% endif %}
{% endif %}


{% if 'update' in entity.operations %}
def test_update_{{ entity.name | lower }}(
    client: TestClient,
    {% if entity.access.update != 'public' %}
    {% if entity.access.update_roles %}test_user_headers: dict[str, str]{% else %}test_user_token: str{% endif %}
    {% endif %}
) -> None:
    """Test updating {{ entity.name }}."""
    data = {
        {% for attr in entity.attributes %}
        {% if not attr.readonly and not attr.is_computed %}
        "{{ attr.name }}": {{ attr.test_value }},
        {% endif %}
        {% endfor %}
    }
    response = client.put(
        "/api/{{ entity.name | lower }}",
        json=data
        {% if entity.access.update != 'public' %}
        , headers=test_user_headers
        {% endif %}
    )
    {% if entity.access.update == 'public' or entity.access.update_roles %}
    assert response.status_code == 200
    result = response.json()
    {% for attr in entity.attributes %}
    {% if not attr.readonly and not attr.is_computed %}
    assert result["{{ attr.name }}"] == data["{{ attr.name }}"]
    {% endif %}
    {% endfor %}
    {% else %}
    # Should fail without proper authentication
    assert response.status_code in [401, 403]
    {% endif %}


{% if entity.access.update_roles and admin_role in entity.access.update_roles %}
def test_update_{{ entity.name | lower }}_unauthorized(client: TestClient) -> None:
    """Test updating {{ entity.name }} without authentication fails."""
    data = {
        {% for attr in entity.attributes %}
        {% if not attr.readonly and not attr.is_computed %}
        "{{ attr.name }}": {{ attr.test_value }},
        {% endif %}
        {% endfor %}
    }
    response = client.put("/api/{{ entity.name | lower }}", json=data)
    assert response.status_code in [401, 403]
{% endif %}
{% endif %}


{% if 'delete' in entity.operations %}
def test_delete_{{ entity.name | lower }}(
    client: TestClient,
    {% if entity.access.delete != 'public' %}
    {% if entity.access.delete_roles %}test_user_headers: dict[str, str]{% else %}test_user_token: str{% endif %}
    {% endif %}
) -> None:
    """Test deleting {{ entity.name }}."""
    response = client.delete(
        "/api/{{ entity.name | lower }}"
        {% if entity.access.delete != 'public' %}
        , headers=test_user_headers
        {% endif %}
    )
    {% if entity.access.delete == 'public' or entity.access.delete_roles %}
    assert response.status_code == 200
    result = response.json()
    assert "message" in result or "detail" in result
    {% else %}
    # Should fail without proper authentication
    assert response.status_code in [401, 403]
    {% endif %}


{% if entity.access.delete_roles and admin_role in entity.access.delete_roles %}
def test_delete_{{ entity.name | lower }}_unauthorized(client: TestClient) -> None:
    """Test deleting {{ entity.name }} without authentication fails."""
    response = client.delete("/api/{{ entity.name | lower }}")
    assert response.status_code in [401, 403]
{% endif %}
{% endif %}


{% if entity.type == 'inbound' %}
def test_websocket_{{ entity.name | lower }}(client: TestClient) -> None:
    """Test WebSocket connection for {{ entity.name }}."""
    with client.websocket_connect("/ws/{{ entity.name | lower }}") as websocket:
        # Test that connection is established
        assert websocket is not None
        # You can add more specific WebSocket tests here
{% endif %}
