"""
Tests for {{ entity.name }} entity.

Generated by FDSL from {{ fdsl_file }}.
"""
import pytest
from fastapi.testclient import TestClient
{% if has_auth %}
from sqlmodel import Session
{% endif %}


{% if 'read' in entity.operations %}
def test_read_{{ entity.name | lower }}(
    client: TestClient
    {%- if entity.access.read != 'public' and entity.access.read_roles -%}
    ,
    test_user_headers: dict[str, str]
    {%- endif %}
) -> None:
    """Test reading {{ entity.name }}."""
    response = client.get("/api/{{ entity.name | lower }}"
        {%- if entity.access.read != 'public' and entity.access.read_roles -%}
        , headers=test_user_headers
        {%- endif -%}
    )
    {% if entity.access.read == 'public' or entity.access.read_roles %}
    assert response.status_code == 200
    data = response.json()
    assert data is not None
    {% if entity.attributes %}
    # Verify response schema
    {% for attr in entity.attributes %}
    {% if not attr.is_computed or attr.readonly %}
    assert "{{ attr.name }}" in data
    {% endif %}
    {% endfor %}
    {% endif %}
    {% else %}
    # Should require authentication
    assert response.status_code in [401, 403]
    {% endif %}


{% if entity.access.read_roles %}
def test_read_{{ entity.name | lower }}_unauthorized(client: TestClient) -> None:
    """Test that reading {{ entity.name }} without auth fails."""
    response = client.get("/api/{{ entity.name | lower }}")
    assert response.status_code in [401, 403]
{% endif %}
{% endif %}


{% if 'create' in entity.operations %}
def test_create_{{ entity.name | lower }}(
    client: TestClient
    {%- if entity.access.create != 'public' and entity.access.create_roles -%}
    ,
    {% if 'admin' in entity.access.create_roles %}admin_user_headers{% else %}test_user_headers{% endif %}: dict[str, str]
    {%- endif %}
) -> None:
    """Test creating {{ entity.name }}."""
    data = {
        {% for attr in entity.attributes %}
        {% if not attr.readonly and not attr.is_computed %}
        "{{ attr.name }}": {{ attr.test_value }},
        {% endif %}
        {% endfor %}
    }
    response = client.post(
        "/api/{{ entity.name | lower }}",
        json=data
        {%- if entity.access.create != 'public' and entity.access.create_roles -%}
        , headers={% if 'admin' in entity.access.create_roles %}admin_user_headers{% else %}test_user_headers{% endif %}
        {%- endif %}
    )
    {% if entity.access.create == 'public' or entity.access.create_roles %}
    assert response.status_code == 200
    result = response.json()
    # Verify created data matches request
    {% for attr in entity.attributes %}
    {% if not attr.readonly and not attr.is_computed %}
    # assert result["{{ attr.name }}"] == data["{{ attr.name }}"]  # May be transformed by backend
    {% endif %}
    {% endfor %}
    {% else %}
    # Should require authentication
    assert response.status_code in [401, 403]
    {% endif %}


{% if entity.access.create_roles %}
def test_create_{{ entity.name | lower }}_unauthorized(client: TestClient) -> None:
    """Test that creating {{ entity.name }} without auth fails."""
    data = {
        {% for attr in entity.attributes %}
        {% if not attr.readonly and not attr.is_computed %}
        "{{ attr.name }}": {{ attr.test_value }},
        {% endif %}
        {% endfor %}
    }
    response = client.post("/api/{{ entity.name | lower }}", json=data)
    assert response.status_code in [401, 403]
{% endif %}
{% endif %}


{% if 'update' in entity.operations %}
def test_update_{{ entity.name | lower }}(
    client: TestClient
    {%- if entity.access.update != 'public' and entity.access.update_roles -%}
    ,
    {% if 'admin' in entity.access.update_roles %}admin_user_headers{% else %}test_user_headers{% endif %}: dict[str, str]
    {%- endif %}
) -> None:
    """Test updating {{ entity.name }}."""
    data = {
        {% for attr in entity.attributes %}
        {% if not attr.readonly and not attr.is_computed %}
        "{{ attr.name }}": {{ attr.test_value }},
        {% endif %}
        {% endfor %}
    }
    response = client.put(
        "/api/{{ entity.name | lower }}",
        json=data
        {%- if entity.access.update != 'public' and entity.access.update_roles -%}
        , headers={% if 'admin' in entity.access.update_roles %}admin_user_headers{% else %}test_user_headers{% endif %}
        {%- endif %}
    )
    {% if entity.access.update == 'public' or entity.access.update_roles %}
    assert response.status_code == 200
    result = response.json()
    # Verify update succeeded
    {% for attr in entity.attributes %}
    {% if not attr.readonly and not attr.is_computed %}
    # assert result["{{ attr.name }}"] == data["{{ attr.name }}"]  # May be transformed by backend
    {% endif %}
    {% endfor %}
    {% else %}
    # Should require authentication
    assert response.status_code in [401, 403]
    {% endif %}


{% if entity.access.update_roles %}
def test_update_{{ entity.name | lower }}_unauthorized(client: TestClient) -> None:
    """Test that updating {{ entity.name }} without auth fails."""
    data = {
        {% for attr in entity.attributes %}
        {% if not attr.readonly and not attr.is_computed %}
        "{{ attr.name }}": {{ attr.test_value }},
        {% endif %}
        {% endfor %}
    }
    response = client.put("/api/{{ entity.name | lower }}", json=data)
    assert response.status_code in [401, 403]
{% endif %}
{% endif %}


{% if 'delete' in entity.operations %}
def test_delete_{{ entity.name | lower }}(
    client: TestClient
    {%- if entity.access.delete != 'public' and entity.access.delete_roles -%}
    ,
    {% if 'admin' in entity.access.delete_roles %}admin_user_headers{% else %}test_user_headers{% endif %}: dict[str, str]
    {%- endif %}
) -> None:
    """Test deleting {{ entity.name }}."""
    response = client.delete(
        "/api/{{ entity.name | lower }}"
        {%- if entity.access.delete != 'public' and entity.access.delete_roles -%}
        , headers={% if 'admin' in entity.access.delete_roles %}admin_user_headers{% else %}test_user_headers{% endif %}
        {%- endif %}
    )
    {% if entity.access.delete == 'public' or entity.access.delete_roles %}
    assert response.status_code == 200
    result = response.json()
    assert "message" in result or "detail" in result
    {% else %}
    # Should require authentication
    assert response.status_code in [401, 403]
    {% endif %}


{% if entity.access.delete_roles %}
def test_delete_{{ entity.name | lower }}_unauthorized(client: TestClient) -> None:
    """Test that deleting {{ entity.name }} without auth fails."""
    response = client.delete("/api/{{ entity.name | lower }}")
    assert response.status_code in [401, 403]
{% endif %}
{% endif %}


{% if entity.type == 'inbound' %}
def test_websocket_{{ entity.name | lower }}(client: TestClient) -> None:
    """Test WebSocket connection for {{ entity.name }}."""
    with client.websocket_connect("/ws/{{ entity.name | lower }}") as websocket:
        # Verify connection established
        assert websocket is not None
        # Can send/receive messages
        # websocket.send_json({"test": "data"})
        # data = websocket.receive_json()
        # assert data is not None
{% endif %}
