# ========================================================================
# AUTO-GENERATED ENTITY ROUTER: {{ entity_name }}
# Generated from entity-centric exposure configuration
# ========================================================================

import logging
from typing import List, Optional

from fastapi import APIRouter, HTTPException, Depends

from app.domain.models import {{ entity_name }}
{%- for op in operations %}
{%- if op.has_request_body %}, {{ op.request_model }}{% endif %}
{%- endfor %}
from app.services.{{ entity_name | lower }}_service import {{ service_name }}
{%- if has_auth %}
from app.core.auth import require_roles
{%- endif %}


logger = logging.getLogger("fdsl.router.{{ entity_name }}")

router = APIRouter(
    prefix="{{ rest_path }}",
    tags=["{{ entity_name }}"]
)


{% for op in operations %}
@router.{{ op.method | lower }}(
    "{{ op.path_suffix }}",
    {%- if op.type != "delete" %}
    response_model={{ op.response_model }},
    {%- endif %}
    status_code={{ op.status_code }}
    {%- if has_auth and op.required_roles != ["public"] %},
    dependencies=[Depends(require_roles({{ op.required_roles }}))]
    {%- endif %}
)
async def {{ op.function_name }}(
    {%- if op.is_item_op %}
    {{ op.id_field }}: str,
    {%- endif %}
    {%- if op.has_request_body %}
    data: {{ op.request_model }},
    {%- endif %}
    {%- if op.type == "list" and op.filters %}
    {%- for filter in op.filters %}
    {{ filter.name }}: Optional[{{ filter.type }}] = None,
    {%- endfor %}
    {%- endif %}
    service: {{ service_name }} = Depends()
){%- if op.type != "delete" %} -> {{ op.response_model }}{% endif %}:
    """{{ op.type | capitalize }} {{ entity_name }}"""
    {%- if op.is_item_op %}
    logger.debug(f"{{ op.type | upper }} {{ entity_name }}: {{ op.id_field }}={{ '{{ ' }}{{ op.id_field }}{{ ' }}' }}")
    {%- else %}
    logger.debug(f"{{ op.type | upper }} {{ entity_name }}")
    {%- endif %}

    {%- if op.type == "list" %}
    {%- if op.filters %}
    # Build filters dict from query parameters
    filters = {}
    {%- for filter in op.filters %}
    if {{ filter.name }} is not None:
        filters['{{ filter.name }}'] = {{ filter.name }}
    {%- endfor %}
    return await service.list_{{ entity_name | lower }}(filters=filters)
    {%- else %}
    return await service.list_{{ entity_name | lower }}()
    {%- endif %}

    {%- elif op.type == "read" %}
    {%- if op.is_item_op %}
    result = await service.get_{{ entity_name | lower }}({{ op.id_field }})
    if not result:
        raise HTTPException(status_code=404, detail="{{ entity_name }} not found")
    return result
    {%- else %}
    # Singleton read - no ID parameter
    return await service.get_{{ entity_name | lower }}()
    {%- endif %}

    {%- elif op.type == "create" %}
    return await service.create_{{ entity_name | lower }}(data)

    {%- elif op.type == "update" %}
    result = await service.update_{{ entity_name | lower }}({{ op.id_field }}, data)
    if not result:
        raise HTTPException(status_code=404, detail="{{ entity_name }} not found")
    return result

    {%- elif op.type == "delete" %}
    await service.delete_{{ entity_name | lower }}({{ op.id_field }})
    {%- endif %}


{% endfor %}
