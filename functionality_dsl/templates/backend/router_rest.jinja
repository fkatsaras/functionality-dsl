# app/api/routers/{{ entity.name | lower }}.py
import time
import logging

from fastapi import APIRouter, HTTPException, Request
from typing import List, Any, Dict

from app.core.http import get_http_client
from app.core.utils import resolve_headers
from app.core.logging import set_request_id
from app.core.expressions import compile_safe
from app.core.computed import DSL_FUNCTION_REGISTRY as dsl_funcs

from app.domain.models import {{ entity.name }}


logger = logging.getLogger("fdsl.router.{{ entity.name }}")
router = APIRouter(prefix="/api/entities/{{ entity.name | lower }}", tags=["{{ entity.name }}"])

_UPSTREAM_URL = "{{ entity.source.url }}"
_HEADERS = resolve_headers([
{% for h in entity.source.headers | default([], true) -%}
    ("{{ h.key }}", "{{ h.value }}"),
{% endfor -%}
])
_METHOD = "{{ (entity.source.verb or 'GET')|upper }}"
_FIELDS = [{% for n in schema_attrs %}"{{ n }}",{% endfor %}]

def _project(x: Dict[str, Any]) -> Dict[str, Any]:
    return {k: x.get(k) for k in _FIELDS}

{% if entity._where_py %}
_WHERE = compile_safe({{ entity._where_py | tojson }})
{% else %}
_WHERE = None
{% endif %}

@router.get("/", response_model=List[{{ entity.name }}])
async def list_{{ entity.name | lower }}(request: Request):
    t0 = time.monotonic()
    rid = getattr(request.state, "request_id", None)
    if rid: set_request_id(rid)

    client = get_http_client()
    try:
        if _METHOD == "GET":
            r = await client.get(_UPSTREAM_URL, headers=_HEADERS)
        else:
            r = await client.request(_METHOD, _UPSTREAM_URL, headers=_HEADERS, json=None)
        elapsed = (time.monotonic() - t0) * 1000.0

        if r.status_code >= 400:
            logger.warning("upstream_error",
                extra={"entity":"{{ entity.name }}","verb":_METHOD,"url":_UPSTREAM_URL,
                       "status":r.status_code,"elapsed_ms":round(elapsed,2)})
            raise HTTPException(status_code=502, detail={"upstream_status": r.status_code, "body": r.text})

        data = r.json()

        print('AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA')
        print('Entity {{ entity.name }} gets')
        print(data)
        print('AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA')

        n = len(data) if isinstance(data, list) else 0
        if not isinstance(data, list):
            logger.error("unexpected_shape", extra={"entity":"{{ entity.name }}","got_type":type(data).__name__})
            raise HTTPException(status_code=502, detail="Upstream did not return a list")

        rows_list: list[{{ entity.name }}] = []
        for d in data:
            row = _project(d)
            if _WHERE is not None:
                try:
                    ok = bool(eval(_WHERE, {"__builtins__": {}, "dsl_funcs": dsl_funcs}, {"row": row}))
                except Exception:
                    ok = False
                if not ok:
                    continue
            rows_list.append({{ entity.name }}(**row))
            
        logger.info("ok",
            extra={"entity":"{{ entity.name }}","rows":len(rows_list),"elapsed_ms":round(elapsed,2)})


        print('AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA')
        print('Entity {{ entity.name }} returns')
        print(rows_list)
        print('AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA')
        return rows_list
    except HTTPException:
        raise
    except Exception as ex:
        logger.exception("router_error",
            extra={"entity":"{{ entity.name }}","verb":_METHOD,"url":_UPSTREAM_URL})
        raise
