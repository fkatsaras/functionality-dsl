# ========================================================================
# AUTO-GENERATED QUERY ROUTER
# ========================================================================

import logging
from typing import Any, Dict, Optional

from fastapi import APIRouter, HTTPException, Request, Query, Header
{% if endpoint.auth and endpoint.auth.kind == 'bearer' %}
from fastapi import Depends
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
security = HTTPBearer()
{% endif %}

from app.services import {{ endpoint.name | lower }}_service


logger = logging.getLogger("fdsl.router.{{ endpoint.name }}")

router = APIRouter(
    prefix="{{ route_prefix }}",
    tags=["{{ endpoint.summary or endpoint.name }}"]
)


{% set pparams = endpoint.path_params or [] %}
@router.get("", response_model=Dict[str, Any])
async def query_{{ endpoint.name | lower }}(
    request: Request,
    {% for p in pparams %}{{ p }}: str, {% endfor %}
    {% if endpoint.auth and endpoint.auth.kind == 'bearer' %}
    credentials: HTTPAuthorizationCredentials = Depends(security),
    {% elif endpoint.auth and endpoint.auth.kind == 'api_key' %}
        {% if endpoint.auth.location == 'header' %}
    {{ endpoint.auth.key | replace('-', '_') | lower }}: Optional[str] = Header(None, alias="{{ endpoint.auth.key }}"),
        {% elif endpoint.auth.location == 'query' %}
    {{ endpoint.auth.key }}: Optional[str] = Query(None),
        {% endif %}
    {% endif %}
):
    """
    Query endpoint for {{ entity.name }}.
    Aggregates data from external sources and internal dependencies,
    then computes the final entity attributes.
    """
    # Authentication
    {% if endpoint.auth %}
    {% if endpoint.auth.kind == 'bearer' %}
    if not credentials or not credentials.credentials:
        raise HTTPException(status_code=401, detail="Missing bearer token")
    {% elif endpoint.auth.kind == 'basic' %}
    # Basic auth validated automatically by FastAPI
    pass
    {% elif endpoint.auth.kind == 'api_key' %}
    # Validate API key
    {% set api_key_param = endpoint.auth.key | replace('-', '_') | lower %}
    if not {{ api_key_param }}:
        raise HTTPException(status_code=401, detail="Missing API key")
    if {{ api_key_param }} != "{{ endpoint.auth.value }}":
        raise HTTPException(status_code=403, detail="Invalid API key")
    {% endif %}
    {% endif %}

    # Forward to service layer
    try:
        path_params = {
            {% for p in pparams %}
            "{{ p }}": {{ p }}{% if not loop.last %},{% endif %}
            {% endfor %}
        }

        # Extract query params and headers for decorated attributes
        query_params = dict(request.query_params)
        headers = dict(request.headers)

        return await {{ endpoint.name | lower }}_service.execute_query(path_params, query_params, headers)

    except HTTPException:
        raise
    except Exception as unexpected_error:
        logger.exception(f"[ERROR] - Unexpected error in query {{ entity.name }}: {unexpected_error}")
        raise HTTPException(status_code=500, detail="Internal server error")