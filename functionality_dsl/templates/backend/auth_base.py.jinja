"""
Shared Authentication Base Module
Auto-generated from FDSL - provides common auth utilities for all auth types.

This module contains:
- TokenPayload class (unified user representation)
- require_roles() factory (role-based access control)
- require_all_roles() factory (all-roles-required access control)
"""

from typing import List, Optional, Callable, Any
from fastapi import HTTPException, status


# ============================================================================
# Token Payload (unified interface for all auth types)
# ============================================================================

class TokenPayload:
    """
    Unified user payload - compatible interface across all auth types.

    Attributes:
        user_id: User identifier (email, username, or ID depending on auth type)
        roles: List of user roles
        token: Optional original token/key for forwarding to external services
    """

    def __init__(self, user_id: str, roles: List[str], token: Optional[str] = None):
        self.user_id = user_id
        self.roles = roles
        self.token = token  # Original token for forwarding

    def has_role(self, role: str) -> bool:
        """Check if user has a specific role."""
        return role in self.roles

    def has_any_role(self, roles: List[str]) -> bool:
        """Check if user has any of the specified roles."""
        return any(self.has_role(role) for role in roles)

    def has_all_roles(self, roles: List[str]) -> bool:
        """Check if user has all of the specified roles."""
        return all(self.has_role(role) for role in roles)


# ============================================================================
# Role Checking Utilities
# ============================================================================

def create_require_roles(
    get_current_user_func: Callable,
    get_optional_user_func: Callable,
):
    """
    Factory to create a require_roles dependency for a specific auth type.

    Args:
        get_current_user_func: The auth-specific get_current_user dependency
        get_optional_user_func: The auth-specific get_optional_user dependency

    Returns:
        A require_roles function configured for the auth type
    """
    from fastapi import Depends

    def require_roles(required_roles: List[str]):
        """
        Dependency factory to require specific roles.

        Args:
            required_roles: List of roles, user must have at least one
                           Special values: "public" (no auth), "authenticated" (any valid auth)

        Returns:
            FastAPI dependency function

        Usage:
            @app.post("/admin-only", dependencies=[Depends(require_roles(["admin"]))])
            async def admin_route():
                return {"message": "Admin access granted"}
        """
        # Special case: public access (no auth required)
        if "public" in required_roles:
            async def _check_roles_or_public(
                user: Optional[TokenPayload] = Depends(get_optional_user_func)
            ):
                """Check if user has required roles OR allow public access"""
                if user is None:
                    return None

                if not user.has_any_role(required_roles):
                    raise HTTPException(
                        status_code=status.HTTP_403_FORBIDDEN,
                        detail=f"Requires one of: {required_roles}. Your roles: {user.roles}"
                    )
                return user

            return _check_roles_or_public

        # Special case: authenticated (any valid auth, no role check)
        if "authenticated" in required_roles:
            async def _check_authenticated(user: TokenPayload = Depends(get_current_user_func)):
                """Require valid authentication, no role check"""
                return user

            return _check_authenticated

        async def _check_roles(user: TokenPayload = Depends(get_current_user_func)):
            """Check if user has required roles"""
            if not user.has_any_role(required_roles):
                raise HTTPException(
                    status_code=status.HTTP_403_FORBIDDEN,
                    detail=f"Requires one of: {required_roles}. Your roles: {user.roles}"
                )
            return user

        return _check_roles

    return require_roles


def create_require_all_roles(get_current_user_func: Callable):
    """
    Factory to create a require_all_roles dependency for a specific auth type.

    Args:
        get_current_user_func: The auth-specific get_current_user dependency

    Returns:
        A require_all_roles function configured for the auth type
    """
    from fastapi import Depends

    def require_all_roles(required_roles: List[str]):
        """
        Dependency factory to require ALL specified roles (not just one).

        Args:
            required_roles: List of roles, user must have ALL of them

        Returns:
            FastAPI dependency function

        Usage:
            @app.post("/super-admin", dependencies=[Depends(require_all_roles(["admin", "superuser"]))])
            async def super_admin_route():
                return {"message": "Super admin access granted"}
        """
        async def _check_all_roles(user: TokenPayload = Depends(get_current_user_func)):
            """Check if user has all required roles"""
            missing_roles = [role for role in required_roles if not user.has_role(role)]
            if missing_roles:
                raise HTTPException(
                    status_code=status.HTTP_403_FORBIDDEN,
                    detail=f"Missing required roles: {missing_roles}. Your roles: {user.roles}"
                )
            return user

        return _check_all_roles

    return require_all_roles
