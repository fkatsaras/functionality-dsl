# app/services/{{ entity.name | lower }}_service.py
from typing import Any, Dict, List
from types import MappingProxyType

from app.domain.models import {{ entity.name }}
from app.core.expressions import compile_safe
from app.core.computed import DSL_FUNCTION_REGISTRY as dsl_funcs
{% for inp in inputs %}
from app.services.{{ inp.target_name | lower }}_service import {{ inp.target_name }}Service
{% endfor %}

# Precompile expressions once
_COMPILED = {
{% for attr in computed_attrs %}
    "{{ attr.name }}": compile_safe({{ attr.pyexpr | tojson }}),
{% endfor %}
}

class {{ entity.name }}Service:
    def __init__(
        self,
{% for inp in inputs %}
        {{ inp.alias }}: {{ inp.target_name }}Service | None = None{{ "," if not loop.last else "" }}
{% endfor %}
    ):
{% for inp in inputs %}
        self.{{ inp.alias }} = {{ inp.alias }} or {{ inp.target_name }}Service()
{% endfor %}

    async def list(self) -> List[{{ entity.name }}]:
        # Fetch inputs (whole lists; components can slice/filter client-side)
{% for inp in inputs %}
        {{ inp.alias }}_items = [i.model_dump() for i in await self.{{ inp.alias }}.list()]
{% endfor %}

        lists = {
{% for inp in inputs %}
            "{{ inp.alias }}": {{ inp.alias }}_items,
{% endfor %}
        }

        n = min((len(v) for v in lists.values()), default=0)
        rows: List[Dict[str, Any]] = []
        for i in range(n):
            ctx = {k: lists[k][i] for k in lists}
            row: Dict[str, Any] = {}
            for name, code in _COMPILED.items():
                row[name] = eval(
                    code,
                    {"__builtins__": {}, "dsl_funcs": dsl_funcs},
                    {"ctx": MappingProxyType(ctx)},
                )
            rows.append(row)

        return [{{ entity.name }}(**it) for it in rows]
