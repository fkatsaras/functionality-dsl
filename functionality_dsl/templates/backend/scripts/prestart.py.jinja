"""
Prestart script for database initialization.

This script runs before the main application starts to:
1. Wait for the database to be ready
2. Create tables if they don't exist
3. Create initial admin user if configured

Generated by FDSL from {{ fdsl_file }}.
"""
import logging
import os
import time
from sqlmodel import Session, select

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


def wait_for_db(max_retries: int = 60, retry_interval: int = 1) -> None:
    """Wait for database to be ready."""
    from app.core.db import engine

    retries = 0
    while retries < max_retries:
        try:
            # Try to connect to the database
            with engine.connect() as conn:
                conn.execute("SELECT 1")
            logger.info("Database is ready!")
            return
        except Exception as e:
            retries += 1
            if retries >= max_retries:
                logger.error(f"Could not connect to database after {max_retries} attempts")
                raise e
            logger.info(f"Waiting for database... (attempt {retries}/{max_retries})")
            time.sleep(retry_interval)


def init_db() -> None:
    """Initialize database tables."""
    from app.core.db import init_db as create_tables

    logger.info("Initializing database tables...")
    create_tables()
    logger.info("Database tables created!")


def create_initial_user() -> None:
    """Create initial admin user if configured via environment variables."""
    from app.core.db import engine
    from app.domain.models import User
    from app.db.password import get_password_hash

    initial_email = os.getenv("INITIAL_ADMIN_EMAIL")
    initial_password = os.getenv("INITIAL_ADMIN_PASSWORD")
    initial_role = os.getenv("INITIAL_ADMIN_ROLE", "{{ admin_role or 'admin' }}")

    if not initial_email or not initial_password:
        logger.info("No initial admin user configured (set INITIAL_ADMIN_EMAIL and INITIAL_ADMIN_PASSWORD)")
        return

    with Session(engine) as session:
        # Check if user already exists
        statement = select(User).where(User.email == initial_email)
        existing_user = session.exec(statement).first()

        if existing_user:
            logger.info(f"Admin user already exists: {initial_email}")
            return

        # Create new admin user
        hashed_password = get_password_hash(initial_password)
        admin_user = User(
            email=initial_email,
            password=hashed_password,
            role=initial_role
        )
        session.add(admin_user)
        session.commit()
        logger.info(f"Created initial admin user: {initial_email}")


def main() -> None:
    """Run prestart tasks."""
    logger.info("Running prestart tasks...")

    # Wait for database
    wait_for_db()

    # Initialize database
    init_db()

    # Create initial admin user
    create_initial_user()

    logger.info("Prestart tasks completed successfully!")


if __name__ == "__main__":
    main()
